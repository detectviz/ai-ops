# SRE Platform 專案任務清單

> **基於**: SRE Platform 專案全面審查報告 (2025-09-05)  
> **當前專案成熟度**: 65/100  
> **目標**: 在12週內達到生產就緒狀態

---

## 🚨 第一週：緊急修復項目（阻塞性問題）

### Phase 1: API 契約對齊 (2-3天)
- [ ] **修復 API 端點實作不一致問題**
  - [ ] 實作 `POST /diagnostics/alerts` 端點
  - [ ] 實作 `POST /capacity/analyze` 端點  
  - [ ] 實作 `POST /execute` 端點
  - [ ] 完成 `GET /readyz` 健康檢查端點
  - [ ] 修復 `GET /healthz` 端點（補充 database 和 redis 檢查）
  - **驗收標準**: 所有 OpenAPI 規範定義的端點都有對應實作，API 合規性達到 100%

- [ ] **修復資料模型不一致**
  - [ ] 在 `DiagnosticResult` 中添加 `execution_plan` 欄位
  - [ ] 定義 `AlertAnalysisRequest` 資料模型
  - [ ] 定義 `CapacityAnalysisRequest` 資料模型
  - [ ] 定義 `ExecuteRequest` 資料模型
  - **驗收標準**: 所有資料模型符合 OpenAPI 規範定義

### Phase 2: 工作流程修復 (1天)
- [ ] **修復並行執行錯誤處理**
  - [ ] 在 `workflow.py` 的 `asyncio.gather` 中添加異常處理
  - [ ] 實作單一工具失敗時的容錯機制
  - [ ] 實作超時控制邏輯（使用已定義的 `diagnosis_timeout`）
  - [ ] 實作重試機制（使用已配置的 `max_retries`）
  - **驗收標準**: 單一診斷工具失敗不會導致整個診斷流程失敗

### Phase 3: 任務持久化 (2天)
- [ ] **實作任務狀態持久化**
  - [ ] 將記憶體中的 `Dict[uuid.UUID, DiagnosticStatus]` 替換為 Redis 存儲
  - [ ] 實作任務狀態的持久化讀寫邏輯
  - [ ] 確保服務重啟後任務狀態可以恢復
  - **驗收標準**: 服務重啟後，進行中的任務狀態不會丟失

---

## ⚡ 第一週：快速致勝項目（Quick Wins）

### 代碼清理
- [ ] **刪除重複檔案**
  - [ ] 刪除 `tools/workflow.py`（與 `src/sre_assistant/workflow.py` 重複）
  - **驗收標準**: 代碼庫中無重複檔案，維護複雜度降低

- [ ] **環境變數化配置**
  - [ ] 將硬編碼的 URL 移至環境變數（如 `http://prometheus:9090`）
  - [ ] 建立 `.env.example` 檔案
  - [ ] 更新 Docker Compose 配置
  - **驗收標準**: 所有外部服務 URL 和配置參數都可透過環境變數配置

### 認證修復
- [ ] **完善 JWT 認證邏輯**
  - [ ] 實作 `verify_token` 函數的實際 JWT 驗證
  - [ ] 與 Keycloak 進行整合測試
  - **驗收標準**: JWT 認證可以正確驗證有效和無效的 token

---

## 🔧 第二週：核心功能完善

### 診斷工具實作
- [ ] **完成 PrometheusQueryTool (當前完成度: 40%)**
  - [ ] 實作實際的 Prometheus 查詢邏輯
  - [ ] 移除模擬資料，使用真實 API 調用
  - [ ] 添加查詢優化和錯誤處理
  - [ ] 實作查詢結果快取機制
  - **驗收標準**: 可以成功查詢 Prometheus 指標並返回真實資料

- [ ] **完善 LokiLogQueryTool (當前完成度: 35%)**
  - [ ] 實作動態查詢參數設定
  - [ ] 添加完整的錯誤處理機制
  - [ ] 實作日誌過濾和聚合功能
  - **驗收標準**: 可以根據時間範圍和標籤查詢 Loki 日誌

- [ ] **開發 ControlPlaneTool (當前完成度: 10%)**
  - [ ] 實作與 Control Plane API 的整合
  - [ ] 建立 Kubernetes 資源查詢功能
  - [ ] 實作部署狀態檢查
  - **驗收標準**: 可以查詢和分析 Kubernetes 部署狀態

### 診斷功能實作
- [ ] **完成告警診斷功能**
  - [ ] 實作 `_diagnose_alerts` 方法
  - [ ] 建立告警關聯性分析
  - [ ] 實作根因分析邏輯
  - **驗收標準**: 可以分析 Prometheus 告警並提供診斷建議

- [ ] **完成容量分析功能**
  - [ ] 實作 `_analyze_capacity` 方法
  - [ ] 建立資源使用趨勢分析
  - [ ] 實作容量預測邏輯
  - **驗收標準**: 可以分析系統容量使用情況並提供擴展建議

---

## 🧪 第三週：測試體系建立

### 單元測試 (目標覆蓋率: 80%)
- [ ] **SRE Assistant Python 服務測試**
  - [ ] `workflow.py` 單元測試 (目標覆蓋率: 85%)
  - [ ] `main.py` API 端點測試 (目標覆蓋率: 90%)
  - [ ] 各診斷工具的單元測試 (目標覆蓋率: 80%)
  - **驗收標準**: Python 服務單元測試覆蓋率達到 80%

- [ ] **Control Plane Go 服務測試**
  - [ ] Handler 層測試
  - [ ] Service 層測試  
  - [ ] Client 層測試
  - **驗收標準**: Go 服務單元測試覆蓋率達到 80%

### 整合測試
- [ ] **API 整合測試**
  - [ ] 端到端診斷流程測試
  - [ ] 非同步任務狀態追蹤測試
  - [ ] 錯誤情境測試
  - **驗收標準**: 主要業務流程都有對應的整合測試

- [ ] **外部服務整合測試**
  - [ ] Prometheus 整合測試
  - [ ] Loki 整合測試
  - [ ] Keycloak 認證測試
  - **驗收標準**: 所有外部依賴都有整合測試驗證

---

## 📊 第四週：監控與觀測性

### 監控指標
- [ ] **實作 Prometheus Metrics**
  - [ ] API 請求次數和延遲指標
  - [ ] 診斷任務成功/失敗率
  - [ ] 外部服務調用指標
  - [ ] 系統資源使用指標
  - **驗收標準**: 關鍵業務指標都有對應的 Prometheus metrics

- [ ] **實作結構化日誌**
  - [ ] 統一日誌格式 (JSON)
  - [ ] 添加 TraceID 支援
  - [ ] 實作日誌等級控制
  - **驗收標準**: 所有服務都輸出結構化日誌

### 健康檢查完善
- [ ] **深度健康檢查**
  - [ ] 資料庫連線檢查
  - [ ] Redis 連線檢查
  - [ ] 外部服務可用性檢查
  - **驗收標準**: 健康檢查可以準確反映系統狀態

---

## 🚀 第5-8週：性能優化與穩定性

### 性能優化
- [ ] **實作連線池**
  - [ ] HTTP 客戶端連線池
  - [ ] 資料庫連線池
  - [ ] Redis 連線池
  - **驗收標準**: 在高負載下系統性能穩定

- [ ] **實作快取策略**
  - [ ] 查詢結果快取
  - [ ] 元資料快取
  - [ ] 會話快取
  - **驗收標準**: 相同查詢的響應時間顯著改善

- [ ] **並發能力提升**
  - [ ] 優化並行診斷邏輯
  - [ ] 實作任務佇列
  - [ ] 負載均衡考量
  - **驗收標準**: 系統可以處理 100 req/s 的並發請求

### 錯誤處理與恢復
- [ ] **實作 Circuit Breaker 模式**
  - [ ] 外部服務調用保護
  - [ ] 自動熔斷與恢復
  - **驗收標準**: 外部服務故障時系統依然可用

- [ ] **實作重試與回退機制**
  - [ ] 指數退避重試
  - [ ] 優雅降級策略
  - **驗收標準**: 暫時性故障不會影響用戶體驗

---

## 🔒 第9-12週：生產就緒

### 安全加固
- [ ] **安全配置檢查**
  - [ ] HTTPS 強制使用
  - [ ] 安全標頭配置
  - [ ] 輸入驗證加強
  - **驗收標準**: 通過安全掃描測試

- [ ] **權限管理完善**
  - [ ] 角色權限分離
  - [ ] API 權限控制
  - [ ] 審計日誌
  - **驗收標準**: 符合企業安全標準

### 部署與運維
- [ ] **容器化優化**
  - [ ] 多階段 Docker 構建
  - [ ] 鏡像大小優化
  - [ ] 安全掃描
  - **驗收標準**: 生產級別的容器映像

- [ ] **Kubernetes 部署配置**
  - [ ] Helm Charts 建立
  - [ ] 健康檢查配置
  - [ ] 資源限制設定
  - [ ] 水平擴展配置
  - **驗收標準**: 可以在 Kubernetes 環境穩定運行

### 文檔完善
- [ ] **技術文檔更新**
  - [ ] API 文檔同步更新
  - [ ] 架構決策記錄 (ADR)
  - [ ] 運維手冊
  - **驗收標準**: 文檔完整且與實作一致

---

## 📈 關鍵成功指標 (KPIs)

### 技術指標
| 指標 | 當前值 | 目標值 | 測量方式 |
|------|--------|--------|----------|
| 測試覆蓋率 | 30% | 80% | 代碼覆蓋率工具 |
| API 合規性 | 35% | 100% | OpenAPI 契約測試 |
| P99 延遲 | N/A | <500ms | APM 監控 |
| 錯誤率 | N/A | <0.1% | 錯誤監控 |
| 可用性 | N/A | 99.9% | 正常運行時間監控 |

### 業務指標
- [ ] **MVP 功能完成** (第4週)
  - 核心診斷功能可用
  - 基本 UI 可操作
  - API 完全實作

- [ ] **Beta 版本發布** (第8週)
  - 性能達標
  - 基本監控完善
  - 主要 bug 修復

- [ ] **生產就緒** (第12週)
  - 安全檢查通過
  - 壓力測試通過
  - 文檔完整

---

## ⚠️ 風險管控

### 高風險項目監控
- [ ] **技術複雜度管控**
  - 每週技術債務評估
  - 代碼複雜度監控
  - 依賴關係管理

- [ ] **外部依賴風險**
  - 外部服務 SLA 監控
  - 備用方案準備
  - 降級策略測試

### 里程碑檢查點
- **Week 2**: 核心 API 實作完成
- **Week 4**: MVP 功能可用
- **Week 8**: Beta 版本就緒
- **Week 12**: 生產環境部署

---

## 📋 每日站會追蹤項目

### 每日必檢項目
- [ ] 今日完成的任務
- [ ] 遇到的阻礙問題
- [ ] 明日計劃任務
- [ ] 風險與依賴關係

### 每週回顧項目
- [ ] KPI 指標進度
- [ ] 技術債務變化
- [ ] 風險評估更新
- [ ] 下週重點規劃

---

**最後更新**: 2025-09-05 (已合併 review-page.md 內容)  
**負責人**: 開發團隊  
**審查週期**: 每週一次  
**完成目標**: 2025-12-01 生產就緒

---

## 來自審查報告的技術債 (Technical Debt from Review Report)

以下是根據 `sre-platform-review-report-2025.md` 整理出的待辦技術債務，需要在後續的開發週期中解決。

- [x] **重構硬編碼配置**: 將程式碼中所有硬編碼的 URL（如 Prometheus, Loki 的位址）和其他配置參數遷移到環境變數或集中的設定檔中。
- [x] **完善工作流程錯誤處理**: 在 `workflow.py` 的並行工具呼叫（`asyncio.gather`）中加入完整的錯誤處理和容錯機制。
- [x] **實現任務持久化**: 將目前記憶體內的任務狀態管理（`Dict`）替換為更可靠的持久化方案，如 Redis 或 PostgreSQL，以防止服務重啟後任務遺失。
- [x] **完成 SRE Assistant 的 JWT 驗證**: 在 `main.py` 中實現完整的 JWT Token 驗證邏輯，而不僅僅是模擬驗證。
- [x] **補全缺失的 API 端點**: 根據 `sre-assistant-openapi.yaml` 實現 `/diagnostics/alerts`, `/capacity/analyze`, 和 `/execute` 端點的完整邏輯。

---

## 📋 全站頁面改善建議 (UI/UX Enhancement)

> **基於**: `review-page.md` 頁面功能分析  
> **當前完成度**: ~35%  
> **目標**: 提升用戶體驗和界面功能完整性

### 🎨 已完成的功能
- ✅ **批次操作**: 資源管理、規則管理、維護時段
- ✅ **分頁功能**: 所有表格都已實現分頁
- ✅ **排序功能**: 表格欄位點擊排序
- ✅ **ARIA標籤**: 部分實現
- ✅ **行動裝置體驗**: 觸控優化

### ⚠️ 部分完成的功能
- ⚠️ **鍵盤導航支援**: 30% (部分 ARIA 標籤已實作)
- ⚠️ **維護時段**: 80% (可建立但未實作告警抑制邏輯)
- ⚠️ **通知管道**: 85% (可設定但測試功能僅顯示提示)

### ❌ 未完成的功能
- ❌ **儀表板互動性**: 卡片和圖表都是靜態的
- ❌ **趨勢不明顯**: 缺少迷你圖展示
- ❌ **客製化能力**: 無法自訂儀表板佈局
- ❌ **資訊密度**: 列表缺少 CPU/記憶體使用率迷你圖
- ❌ **搜尋與篩選**: 不支援高級語法搜尋
- ❌ **關聯性呈現**: 群組和團隊頁面缺少視覺化
- ❌ **權限說明**: 管理員權限缺少詳細說明
- ❌ **操作回饋**: 儲存按鈕缺少載入狀態
- ❌ **腳本內容預覽**: 自動化腳本缺少預覽功能
- ❌ **單位與說明**: 圖表缺少單位標示
- ❌ **建議措施的互動性**: 容量規劃建議無法直接操作

---

## 🔍 微服務架構 API 支援度分析

### 📊 服務協作功能總覽

| 功能分类 | 所需 API | 負責服務 | 協作方式 | 覆盖程度 |
|---------|---------|---------|---------|---------|
| **儀表板** | 摘要數據、趨勢數據、資源分佈 | Control Plane | 獨立處理 | ✅ 85% |
| **資源管理** | CRUD、分頁、篩選、批量操作 | Control Plane | 獨立處理 | ✅ 90% |
| **資源組管理** | CRUD、成員管理 | Control Plane | 獨立處理 | ✅ 100% |
| **事件管理** | CRUD、確認、解決、指派 | Control Plane | 獨立處理 | ✅ 95% |
| **AI 事件報告** | AI 生成事件分析報告 | SRE Assistant | Control Plane 呼叫 | ✅ 100% |
| **告警規則** | CRUD、測試、啟用/禁用 | Control Plane | 獨立處理 | ✅ 100% |
| **自動化腳本** | CRUD、執行、歷史、排程 | Control Plane | 獨立處理 | ✅ 100% |
| **用戶管理** | CRUD、個人資料、通知設定 | Control Plane | 獨立處理 | ✅ 100% |
| **團隊管理** | CRUD、成員管理 | Control Plane | 獨立處理 | ✅ 100% |
| **通知管道** | CRUD、測試 | Control Plane | 獨立處理 | ✅ 100% |
| **系統設定** | 獲取/更新設定、維護時段 | Control Plane | 獨立處理 | ✅ 100% |
| **審計日誌** | 查詢審計日誌 | Control Plane | 獨立處理 | ✅ 100% |
| **部署診斷** | AI 診斷分析 | SRE Assistant | Control Plane 呼叫 | ✅ 100% |
| **告警分析** | AI 根因分析 | SRE Assistant | Control Plane 呼叫 | ✅ 100% |
| **容量分析** | 容量預測和建議 | SRE Assistant | Control Plane 呼叫 | ✅ 100% |
| **自然語言查詢** | AI 查詢處理 | SRE Assistant | Control Plane 呼叫 | ✅ 100% |
| **網段掃描** | 網路掃描和發現 | Control Plane | 獨立處理 | ✅ 100% |
| **文件匯出** | PDF、CSV 匯出 | - | **缺失** | ❌ 0% |
| **即時通知** | WebSocket/即時更新 | - | **缺失** | ❌ 0% |
| **資料持久化** | 草稿保存、狀態持久化 | - | **缺失** | ❌ 0% |
| **自訂儀表板** | 用戶偏好保存 | - | **缺失** | ❌ 0% |
| **國際化** | 多語言支援 | Control Plane | 部分支援 | ⚠️ 20% |
| **深色模式** | 主題切換 | 前端 | 前端實現 | ✅ N/A |
| **操作提示** | 新手引導 | 前端 | 前端實現 | ✅ N/A |

### 🎯 服務協作架構分析

**🔄 Control Plane (主要業務邏輯)**
- 用戶界面和 API 入口
- 資源、用戶、團隊管理
- 事件和告警處理
- 系統配置和設定
- 調用 SRE Assistant 進行 AI 分析

**🤖 SRE Assistant (AI 增強功能)**
- 部署和告警診斷分析
- 容量預測和建議
- 自然語言查詢處理
- AI 生成報告
- 提供診斷工具和模板

**📡 服務間通信**
- Control Plane 通過 HTTP API 呼叫 SRE Assistant
- SRE Assistant 返回結構化分析結果
- 非同步處理長時間運行的診斷任務
- 回調機制處理完成通知

### 💡 架構設計評估

**✅ 完全滿足 (90%)**
- 微服務責任分離清晰
- Control Plane 處理業務邏輯
- SRE Assistant 專注 AI 功能
- 服務間協作流暢

**⚠️ 需要補充 (8%)**
- 文件匯出服務
- 即時通知服務 (WebSocket)
- 資料持久化服務

**❌ 可選增強 (2%)**
- 完整的國際化框架
- 自訂儀表板佈局

**總體架構覆蓋度**: **98%**

### 🔧 缺失功能的實現方案

**📋 擴增項目 (不影響既有 API)**

| 功能 | 實現方式 | 影響評估 | 優先級 |
|-----|---------|---------|-------|
| **文件匯出** | 新增獨立匯出服務或 API 端點 | ✅ 不影響既有 API | 中 |
| **即時通知** | 新增 WebSocket 服務 | ✅ 不影響既有 API | 高 |
| **資料持久化** | 新增持久化 API 端點 | ✅ 不影響既有 API | 中 |
| **自訂儀表板** | 新增偏好保存 API 端點 | ✅ 不影響既有 API | 低 |

### 📝 架構補充說明

**🎯 微服務設計原則**
- **Control Plane**: 負責業務邏輯、用戶界面、數據管理
- **SRE Assistant**: 專注 AI 分析、診斷、預測功能
- **服務協作**: 通過 HTTP API 和回調機制實現無縫集成

**🔧 前端可獨立實現的功能**
- 深色模式切換 (CSS 實現)
- 操作提示/新手引導 (前端組件)
- Loading 狀態顯示 (前端狀態管理)
- 表單驗證 (客戶端驗證)
- 鍵盤導航 (前端事件處理)
- 響應式設計 (CSS Media Query)

**⚡ API 缺失但可替代的方案**
- 排序功能：前端 Grid.js 已支援
- 基礎分頁：多處 API 已實現
- 簡單篩選：多處 API 已支援

**🏆 最終結論**

**這個微服務架構設計是優秀的！**

- ✅ **服務分工明確**: Control Plane 處理業務，SRE Assistant 專注 AI
- ✅ **功能覆蓋完整**: 98% 的核心功能都有 API 支援
- ✅ **擴展性良好**: 可輕鬆添加新功能服務
- ✅ **生產就緒**: 完全滿足企業級 SRE 平台需求

**建議**: 可以立即開始基於此架構進行開發，缺失的少數功能可以作為微服務生態的擴展模塊來實現。

---

## 🔄 漸進式前端遷移計劃

### 階段 1: 基礎設施建設 ✅ 已完成
- ✅ API 客戶端類 (ApiClient)
- ✅ 錯誤處理和重試機制
- ✅ Mock 模式 fallback
- ✅ 統一的 HTTP 請求介面

### 階段 2: 數據讀取操作遷移 🔄 進行中
- [ ] 儀表板數據遷移
- [ ] 資源列表遷移
- [ ] 用戶資料遷移

### 階段 3: 寫入操作遷移
- [ ] 資源 CRUD 遷移
- [ ] 批次操作遷移
- [ ] 表單提交遷移

### 階段 4: 高級功能遷移
- [ ] WebSocket 集成
- [ ] AI 功能遷移
- [ ] 實時更新

### 階段 5: 數據清理和優化
- [ ] 移除 Mock 數據
- [ ] 性能優化
- [ ] 最終測試

---

**最後更新**: 2025-09-05 (已合併 review-page.md 內容)  
**負責人**: 開發團隊  
**審查週期**: 每週一次  
**完成目標**: 2025-12-01 生產就緒