# SRE Platform SRE Assistant API Specification
# Version: 1.0.0
# Description: API specification for SRE Platform SRE Assistant (Python + FastAPI + Google ADK)

openapi: 3.0.3
info:
  title: SRE Platform SRE Assistant API
  description: |
    SRE Platform SRE Assistant çš„ API è¦ç¯„ï¼ŒåŸºæ–¼ Python + FastAPI + Google ADK æŠ€è¡“æ£§ã€‚

    ## æœå‹™å®šä½
    SRE Assistant æ˜¯ç„¡ç•Œé¢çš„ AI å°ˆå®¶ä»£ç†æœå‹™ï¼Œå°ˆé–€è² è²¬ï¼š
    - ğŸ§  æ™ºèƒ½è¨ºæ–·ï¼šåˆ©ç”¨ AI åˆ†æéƒ¨ç½²ã€å‘Šè­¦å’Œç³»çµ±å•é¡Œ
    - ğŸ“Š å®¹é‡é æ¸¬ï¼šåŸºæ–¼æ­·å²æ•¸æ“šé æ¸¬è³‡æºéœ€æ±‚è¶¨å‹¢
    - ğŸ” æ ¹å› åˆ†æï¼šè‡ªå‹•é—œè¯å‘Šè­¦ï¼Œæ‰¾å‡ºå•é¡Œæ ¹æº
    - ğŸ¤– è‡ªå‹•åŒ–åŸ·è¡Œï¼šåŸ·è¡Œè¤‡é›œçš„ SRE å·¥ä½œæµç¨‹
    - ğŸ› ï¸ å·¥å…·æ•´åˆï¼šä¸²æ¥ Prometheusã€Lokiã€Kubernetes ç­‰å¹³å°

    ## API åˆ†é¡
    - **Core**: æ ¸å¿ƒç³»çµ±åŠŸèƒ½ï¼ˆå¥åº·æª¢æŸ¥ã€èªè­‰ï¼‰
    - **Diagnostics**: è¨ºæ–·åˆ†æ
    - **Capacity**: å®¹é‡è¦åŠƒ
    - **Execute**: é€šç”¨åŸ·è¡Œ
    - **Workflows**: å·¥ä½œæµç®¡ç†
    - **Tools**: å·¥å…·ç‹€æ…‹
  version: 1.0.0
  contact:
    name: SRE Platform Team
    email: sre-platform@example.com
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: http://localhost:8000
    description: SRE Assistant Development Server
  - url: https://sre-assistant.example.com
    description: Production Server

tags:
  - name: Core
    description: æ ¸å¿ƒç³»çµ±åŠŸèƒ½
  - name: Diagnostics
    description: è¨ºæ–·åˆ†æ
  - name: Capacity
    description: å®¹é‡è¦åŠƒ
  - name: Execute
    description: é€šç”¨åŸ·è¡Œ
  - name: Workflows
    description: å·¥ä½œæµç®¡ç†
  - name: Tools
    description: å·¥å…·ç‹€æ…‹

paths:
  # ============================================
  # Core - æ ¸å¿ƒç³»çµ±åŠŸèƒ½
  # ============================================
  /healthz:
    get:
      tags: [Core]
      summary: æœå‹™å¥åº·æª¢æŸ¥
      description: æª¢æŸ¥æœå‹™æ˜¯å¦å­˜æ´»
      operationId: checkHealth
      responses:
        "200":
          description: æœå‹™å¥åº·
          content:
            application/json:
              schema:
                type: object
                required:
                  - status
                  - timestamp
                  - service
                  - version
                properties:
                  status:
                    type: string
                    enum: [ok]
                  timestamp:
                    type: string
                    format: date-time
                  service:
                    type: string
                    enum: [sre-assistant]
                  version:
                    type: string

  /readyz:
    get:
      tags: [Core]
      summary: æœå‹™å°±ç·’æª¢æŸ¥
      description: æª¢æŸ¥æœå‹™åŠå…¶ä¾è³´æ˜¯å¦å°±ç·’
      operationId: checkReadiness
      responses:
        "200":
          description: æœå‹™å°±ç·’
          content:
            application/json:
              schema:
                type: object
                required:
                  - ready
                  - dependencies
                  - timestamp
                properties:
                  ready:
                    type: boolean
                  dependencies:
                    type: object
                    properties:
                      prometheus:
                        type: object
                        properties:
                          status:
                            type: string
                            enum: [healthy, unhealthy]
                          response_time:
                            type: string
                      loki:
                        type: object
                        properties:
                          status:
                            type: string
                            enum: [healthy, unhealthy]
                          response_time:
                            type: string
                      control_plane:
                        type: object
                        properties:
                          status:
                            type: string
                            enum: [healthy, unhealthy]
                          response_time:
                            type: string
                      adk_runtime:
                        type: object
                        properties:
                          status:
                            type: string
                            enum: [ready, not_ready]
                          model_loaded:
                            type: boolean
                  timestamp:
                    type: string
                    format: date-time
        "503":
          description: æœå‹™æœªå°±ç·’

  /metrics:
    get:
      tags: [Core]
      summary: Prometheus æŒ‡æ¨™
      description: ç²å– Prometheus æ ¼å¼çš„ç³»çµ±æŒ‡æ¨™
      operationId: getMetrics
      responses:
        "200":
          description: Prometheus æŒ‡æ¨™
          content:
            text/plain:
              schema:
                type: string

  # ============================================
  # Diagnostics - è¨ºæ–·åˆ†æ
  # ============================================
  /api/v1/diagnostics/deployment:
    post:
      tags: [Diagnostics]
      summary: éƒ¨ç½²è¨ºæ–·
      description: åˆ†æéƒ¨ç½²å•é¡Œä¸¦æä¾›è¨ºæ–·å ±å‘Š
      operationId: diagnoseDeployment
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DiagnosticRequest"
      responses:
        "202":
          description: è¨ºæ–·ä»»å‹™å·²æ¥å—
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DiagnosticResponse"

  /api/v1/diagnostics/alerts:
    post:
      tags: [Diagnostics]
      summary: å‘Šè­¦é—œè¯åˆ†æ
      description: åˆ†æå¤šå€‹å‘Šè­¦ä¹‹é–“çš„é—œè¯æ€§ä¸¦æä¾›æ ¹å› åˆ†æ
      operationId: analyzeAlerts
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AlertAnalysisRequest"
      responses:
        "202":
          description: åˆ†æä»»å‹™å·²æ¥å—
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DiagnosticResponse"

  /api/v1/diagnostics/{sessionId}/status:
    get:
      tags: [Diagnostics]
      summary: æŸ¥è©¢è¨ºæ–·ç‹€æ…‹
      description: æŸ¥è©¢éåŒæ­¥è¨ºæ–·ä»»å‹™çš„ç‹€æ…‹
      operationId: getDiagnosticStatus
      security:
        - bearerAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: è¨ºæ–·ç‹€æ…‹
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DiagnosticStatusResponse"

  # ============================================
  # Capacity - å®¹é‡è¦åŠƒ
  # ============================================
  /api/v1/capacity/analyze:
    post:
      tags: [Capacity]
      summary: å®¹é‡åˆ†æ
      description: åˆ†æè³‡æºä½¿ç”¨è¶¨å‹¢ä¸¦é æ¸¬å®¹é‡éœ€æ±‚
      operationId: analyzeCapacity
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CapacityAnalysisRequest"
      responses:
        "200":
          description: å®¹é‡åˆ†æçµæœ
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CapacityAnalysisResponse"

  # ============================================
  # Execute - é€šç”¨åŸ·è¡Œ
  # ============================================
  /api/v1/execute:
    post:
      tags: [Execute]
      summary: è‡ªç„¶èªè¨€æŸ¥è©¢
      description: æ¥å—è‡ªç„¶èªè¨€æŸ¥è©¢ï¼ŒAI è‡ªå‹•è§£æä¸¦åŸ·è¡Œç›¸æ‡‰æ“ä½œ
      operationId: executeQuery
      security:
        - bearerAuth: []
      parameters:
        - name: stream
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: æ˜¯å¦ä½¿ç”¨ä¸²æµå›æ‡‰æ¨¡å¼
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExecuteRequest"
      responses:
        "200":
          description: æŸ¥è©¢åŸ·è¡Œå®Œæˆ
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExecuteResponse"
        "202":
          description: æŸ¥è©¢å·²æ¥å—ï¼ˆä¸²æµæ¨¡å¼ï¼‰
        "400":
          description: è«‹æ±‚åƒæ•¸éŒ¯èª¤
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  # ============================================
  # Workflows - å·¥ä½œæµç®¡ç†
  # ============================================
  /api/v1/workflows/templates:
    get:
      tags: [Workflows]
      summary: ç²å–å·¥ä½œæµæ¨¡æ¿
      description: ç²å–æ‰€æœ‰å¯ç”¨çš„å·¥ä½œæµæ¨¡æ¿
      operationId: listWorkflowTemplates
      security:
        - bearerAuth: []
      responses:
        "200":
          description: å·¥ä½œæµæ¨¡æ¿åˆ—è¡¨
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/WorkflowTemplateList"

  # ============================================
  # Tools - å·¥å…·ç‹€æ…‹
  # ============================================
  /api/v1/tools/status:
    get:
      tags: [Tools]
      summary: å·¥å…·ç‹€æ…‹æª¢æŸ¥
      description: æª¢æŸ¥æ‰€æœ‰å¤–éƒ¨å·¥å…·çš„é€£ç·šç‹€æ…‹å’Œå¯ç”¨æ€§
      operationId: getToolStatus
      security:
        - bearerAuth: []
      responses:
        "200":
          description: å·¥å…·ç‹€æ…‹
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ToolStatusResponse"

# ============================================
# Components
# ============================================
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: M2M JWT Token

  schemas:
    # ============================================
    # Common Schemas
    # ============================================
    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: éŒ¯èª¤ä»£ç¢¼
        message:
          type: string
          description: éŒ¯èª¤è¨Šæ¯
        details:
          type: object
          description: éŒ¯èª¤è©³æƒ…
        request_id:
          type: string
          description: è«‹æ±‚è¿½è¹¤ ID
        timestamp:
          type: string
          format: date-time

    # ============================================
    # Diagnostic Schemas
    # ============================================
    DiagnosticRequest:
      type: object
      required:
        - incident_id
        - severity
        - title
        - description
        - affected_services
        - time_range
      properties:
        incident_id:
          type: string
        severity:
          type: string
          enum: [P0, P1, P2, P3]
        title:
          type: string
        description:
          type: string
        affected_services:
          type: array
          items:
            type: string
        time_range:
          type: object
          required:
            - start
            - end
          properties:
            start:
              type: string
              format: date-time
            end:
              type: string
              format: date-time
        context:
          type: object
          properties:
            deployment_id:
              type: string
            namespace:
              type: string
            cluster:
              type: string

    DiagnosticResponse:
      type: object
      required:
        - session_id
        - status
        - message
        - estimated_time
        - workflow_steps
      properties:
        session_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [accepted]
        message:
          type: string
        estimated_time:
          type: integer
          description: é ä¼°åŸ·è¡Œæ™‚é–“ï¼ˆç§’ï¼‰
        workflow_steps:
          type: array
          items:
            type: string

    DiagnosticStatusResponse:
      type: object
      required:
        - session_id
        - status
        - progress
        - current_step
        - execution_time
      properties:
        session_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, processing, completed, failed]
        progress:
          type: integer
          minimum: 0
          maximum: 100
        current_step:
          type: string
        execution_time:
          type: number
          format: float
        result:
          type: object
          description: è¨ºæ–·çµæœï¼ˆåƒ…åœ¨ status ç‚º completed æ™‚å­˜åœ¨ï¼‰
        error:
          type: object
          description: éŒ¯èª¤ä¿¡æ¯ï¼ˆåƒ…åœ¨ status ç‚º failed æ™‚å­˜åœ¨ï¼‰
          properties:
            error:
              type: string
            message:
              type: string
            details:
              type: object

    AlertAnalysisRequest:
      type: object
      required:
        - alert_ids
      properties:
        alert_ids:
          type: array
          items:
            type: string
        correlation_window:
          type: integer
          description: é—œè¯åˆ†ææ™‚é–“çª—å£ï¼ˆç§’ï¼‰
          default: 300
        analysis_depth:
          type: string
          enum: [basic, deep]
          default: basic
        include_metrics:
          type: boolean
          default: true
        include_logs:
          type: boolean
          default: true

    # ============================================
    # Capacity Schemas
    # ============================================
    CapacityAnalysisRequest:
      type: object
      required:
        - target
        - metrics
        - analysis_type
      properties:
        target:
          type: object
          required:
            - type
          properties:
            type:
              type: string
              enum: [resource_group, resource]
            ids:
              type: array
              items:
                type: string
        metrics:
          type: array
          items:
            type: string
            enum: [cpu_usage, memory_usage, disk_usage, network_usage]
        analysis_type:
          type: string
          enum: [current, forecast, optimization]
        forecast_horizon_days:
          type: integer
          description: é æ¸¬å¤©æ•¸ï¼ˆåƒ…åœ¨ analysis_type ç‚º forecast æ™‚æœ‰æ•ˆï¼‰
        historical_period_days:
          type: integer
          description: æ­·å²æ•¸æ“šæœŸé–“ï¼ˆå¤©ï¼‰
          default: 90
        optimization_target:
          type: string
          enum: [performance, cost_efficiency]

    CapacityAnalysisResponse:
      type: object
      required:
        - analysis_id
        - status
        - current_usage
      properties:
        analysis_id:
          type: string
        status:
          type: string
          enum: [completed]
        current_usage:
          type: object
          properties:
            cpu:
              type: object
              properties:
                current_cores:
                  type: number
                  format: float
                allocated_cores:
                  type: number
                  format: float
                utilization_percent:
                  type: number
                  format: float
                trend_7d:
                  type: string
            memory:
              type: object
              properties:
                current_gb:
                  type: number
                  format: float
                allocated_gb:
                  type: number
                  format: float
                utilization_percent:
                  type: number
                  format: float
                trend_7d:
                  type: string
        forecast_results:
          type: object
        recommendations:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
              resource:
                type: string
              priority:
                type: string
                enum: [low, medium, high, immediate]
              current_allocation:
                type: number
                format: float
              recommended_allocation:
                type: number
                format: float
              reasoning:
                type: string
              cost_impact:
                type: object
                properties:
                  monthly_increase:
                    type: number
                    format: float
                  currency:
                    type: string

    # ============================================
    # Execute Schemas
    # ============================================
    ExecuteRequest:
      type: object
      required:
        - query
      properties:
        query:
          type: string
          description: è‡ªç„¶èªè¨€æŸ¥è©¢
        context:
          type: object
          properties:
            namespace:
              type: string
            user_role:
              type: string
        options:
          type: object
          properties:
            include_visualizations:
              type: boolean
              default: false
            response_format:
              type: string
              enum: [structured, text]
              default: structured
            max_execution_time:
              type: integer
              description: æœ€å¤§åŸ·è¡Œæ™‚é–“ï¼ˆç§’ï¼‰
              default: 60

    ExecuteResponse:
      type: object
      required:
        - execution_id
        - status
        - query_understanding
        - results
        - tools_invoked
      properties:
        execution_id:
          type: string
        status:
          type: string
          enum: [completed]
        query_understanding:
          type: object
          properties:
            intent:
              type: string
            entities:
              type: object
            confidence:
              type: number
              format: float
        results:
          type: object
        tools_invoked:
          type: array
          items:
            type: object
            properties:
              tool:
                type: string
              query:
                type: string
              execution_time:
                type: number
                format: float

    # ============================================
    # Workflow Schemas
    # ============================================
    WorkflowTemplateList:
      type: object
      required:
        - templates
      properties:
        templates:
          type: array
          items:
            type: object
            required:
              - id
              - name
              - description
              - version
              - steps
              - estimated_duration
              - success_rate
            properties:
              id:
                type: string
              name:
                type: string
              description:
                type: string
              version:
                type: string
              steps:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                    tool:
                      type: string
              estimated_duration:
                type: integer
                description: é ä¼°åŸ·è¡Œæ™‚é–“ï¼ˆç§’ï¼‰
              success_rate:
                type: number
                format: float

    # ============================================
    # Tool Schemas
    # ============================================
    ToolStatusResponse:
      type: object
      required:
        - tools
      properties:
        tools:
          type: object
          additionalProperties:
            type: object
            required:
              - status
            properties:
              status:
                type: string
                enum: [healthy, unhealthy, unavailable]
              endpoint:
                type: string
              response_time:
                type: string
              capabilities:
                type: array
                items:
                  type: string
