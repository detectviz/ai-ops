# 循環代理

## `LoopAgent`

`LoopAgent` 是一個工作流程代理，它以循環 (即迭代) 方式執行其子代理。它會**重複執行**一系列代理，直到達到指定的迭代次數或滿足終止條件為止。

當您的工作流程涉及重複或迭代改進時，例如修改程式碼，請使用 `LoopAgent`。

### 範例

* 您想要建立一個可以產生食物影像的代理，但有時當您想要產生特定數量的項目 (例如 5 根香蕉) 時，它會在影像中產生不同數量的項目 (例如 7 根香蕉的影像)。您有兩個工具：`Generate Image`、`Count Food Items`。因為您希望不斷產生影像，直到它正確產生指定數量的項目，或者在一定的迭代次數之後，您應該使用 `LoopAgent` 來建構您的代理。

與其他[工作流程代理](index.md)一樣，`LoopAgent` 不由 LLM 驅動，因此其執行方式是確定性的。也就是說，工作流程代理只關心其執行 (即在循環中)，而不關心其內部邏輯；工作流程代理的工具或子代理可能會或可能不會利用 LLM。

### 運作方式

當呼叫 `LoopAgent` 的 `Run Async` 方法時，它會執行以下操作：

1. **子代理執行：**  它會*依序*迭代子代理列表。對於*每個*子代理，它會呼叫代理的 `Run Async` 方法。
2. **終止檢查：**

    *至關重要的是*，`LoopAgent` 本身*不會*固有地決定何時停止循環。您*必須*實作一個終止機制以防止無限循環。常見的策略包括：

    * **最大迭代次數**：在 `LoopAgent` 中設定最大迭代次數。**循環將在該次數後終止**。
    * **來自子代理的提升**：設計一個或多個子代理來評估一個條件 (例如，「文件品質是否足夠好？」，「是否已達成共識？」)。如果滿足條件，子代理可以發出終止訊號 (例如，透過引發自訂事件、在共用上下文中設定旗標或傳回特定值)。

![Loop Agent](../../assets/loop-agent.png)

### 完整範例：迭代式文件改進

想像一個您想要迭代改進文件的場景：

* **寫作代理：** 一個 `LlmAgent`，用於產生或修改關於某個主題的草稿。
* **評論代理：** 一個 `LlmAgent`，用於評論草稿，找出需要改進的地方。

    ```py
    LoopAgent(sub_agents=[WriterAgent, CriticAgent], max_iterations=5)
    ```

在此設定中，`LoopAgent` 將管理迭代過程。`CriticAgent` 可以被**設計為在文件達到令人滿意的品質等級時傳回「停止」訊號**，以防止進一步的迭代。或者，可以使用 `max iterations` 參數將流程限制為固定的循環次數，或者可以實作外部邏輯來做出停止決定。**循環最多會執行五次**，以確保迭代改進不會無限期地繼續下去。

???+ "完整程式碼"

    === "Python"
        ```py
        --8<-- "examples/python/snippets/agents/workflow-agents/loop_agent_doc_improv_agent.py:init"
        ```
    === "Java"
        ```java
        --8<-- "examples/java/snippets/src/main/java/agents/workflow/LoopAgentExample.java:init"
        ```
