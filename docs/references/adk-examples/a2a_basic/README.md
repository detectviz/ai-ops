# A2A 基本範例代理

此範例展示了代理開發套件 (Agent Development Kit, ADK) 中的 **代理對代理 (Agent-to-Agent, A2A)** 架構，說明多個代理如何協同處理複雜任務。此範例實作了一個可以擲骰子並檢查數字是否為質數的代理。

## 總覽

A2A 基本範例包含：

- **根代理 (Root Agent)** (`root_agent`)：將任務委派給專門子代理的主要協調者。
- **擲骰代理 (Roll Agent)** (`roll_agent`)：處理擲骰子操作的本地子代理。
- **質數代理 (Prime Agent)** (`prime_agent`)：一個遠端的 A2A 代理，負責檢查數字是否為質數，此代理在一個獨立的 A2A 伺服器上執行。

## 架構

```
┌─────────────────┐    ┌──────────────────┐    ┌────────────────────┐
│   根代理        │───▶│   擲骰代理       │    │   遠端質數代理     │
│  (本地)         │    │   (本地)         │    │   (localhost:8001) │
│                 │    │                  │    │                    │
│                 │───▶│                  │◀───│                    │
└─────────────────┘    └──────────────────┘    └────────────────────┘
```

## 主要功能

### 1. **本地子代理整合**
- `roll_agent` 展示了如何建立與整合本地子代理。
- 處理可設定面數的骰子擲骰。
- 使用一個簡單的函式工具 (`roll_die`) 來產生隨機數。

### 2. **遠端 A2A 代理整合**
- `prime_agent` 展示了如何連接到遠端代理服務。
- 透過 HTTP 與位於 `http://localhost:8001/a2a/check_prime_agent` 的獨立服務進行通訊。
- 展示跨服務的代理通訊。

### 3. **代理協調**
- 根代理根據使用者請求智慧地委派任務。
- 可以鏈接操作（例如，「擲一個骰子並檢查它是否為質數」）。
- 提供多個代理之間清晰的工作流程協調。

### 4. **範例工具整合**
- 包含一個帶有範例互動的 `ExampleTool` 以提供上下文。
- 協助代理理解預期的行為模式。

## 設定與使用

### 前提條件

1. **啟動遠端質數代理伺服器**：
   ```bash
   # 啟動遠端 a2a 伺服器，該伺服器在 8001 連接埠上提供檢查質數代理服務
   adk api_server --a2a --port 8001 contributing/samples/a2a_basic/remote_a2a
   ```

2. **執行主要代理**：
   ```bash
   # 在另一個終端機中，執行 adk web 伺服器
   adk web contributing/samples/
   ```

### 互動範例

當兩個服務都執行後，您可以與根代理進行互動：

**簡單的擲骰子：**
```
User: 擲一個 6 面骰
Bot: 我為您擲出了一個 4。
```

**檢查質數：**
```
User: 7 是質數嗎？
Bot: 是的，7 是質數。
```

**組合操作：**
```
User: 擲一個 10 面骰並檢查它是否為質數
Bot: 我為您擲出了一個 8。
Bot: 8 不是質數。
```

## 程式碼結構

### 主要代理 (`agent.py`)

- **`roll_die(sides: int)`**：用於擲骰子的函式工具。
- **`roll_agent`**：專門處理擲骰子的本地代理。
- **`prime_agent`**：遠端 A2A 代理設定。
- **`root_agent`**：具備委派邏輯的主要協調者。

### 遠端質數代理 (`remote_a2a/check_prime_agent/`)

- **`agent.py`**：質數檢查服務的實作。
- **`agent.json`**：A2A 代理的代理卡 (Agent Card)。
- **`check_prime(nums: list[int])`**：質數檢查演算法。


## 擴充範例

您可以透過以下方式擴充此範例：

- 新增更多數學運算（如因式分解、平方根等）。
- 建立額外的遠端代理。
- 實作更複雜的委派邏輯。
- 新增持久性狀態管理。
- 與外部 API 或資料庫整合。

## 部署至其他環境

當將遠端 A2A 代理部署到不同環境（例如 Cloud Run、不同的主機/連接埠）時，您 **必須** 更新代理卡 JSON 檔案中的 `url` 欄位：

### 本地開發
```json
{
  "url": "http://localhost:8001/a2a/check_prime_agent",
  ...
}
```

### Cloud Run 範例
```json
{
  "url": "https://your-service-abc123-uc.a.run.app/a2a/check_prime_agent",
  ...
}
```

### 自訂主機/連接埠範例
```json
{
  "url": "https://your-domain.com:9000/a2a/check_prime_agent",
  ...
}
```

**重要事項：** `remote_a2a/check_prime_agent/agent.json` 中的 `url` 欄位必須指向您遠端 A2A 代理實際部署且可存取的 RPC 端點。

## 疑難排解

**連線問題：**
- 確保本地 ADK Web 伺服器在 8000 連接埠上執行。
- 確保遠端 A2A 伺服器在 8001 連接埠上執行。
- 檢查是否有防火牆阻擋 localhost 連線。
- **確認 `remote_a2a/check_prime_agent/agent.json` 中的 `url` 欄位與您遠端 A2A 伺服器的實際部署位置相符。**
- 確認傳遞給 `RemoteA2AAgent` 建構函式的代理卡 URL 與正在執行的 A2A 伺服器相符。


**代理無回應：**
- 檢查 8000 連接埠上的本地 ADK Web 伺服器與 8001 連接埠上的遠端 A2A 伺服器的日誌。
- 確認代理的指令清晰明確。
- **再次檢查 `agent.json` 檔案中的 RPC URL 是否正確且可存取。**
