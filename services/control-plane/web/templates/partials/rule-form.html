{{$isEdit := .Rule}}
<div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50" hx-target="this" hx-swap="outerHTML">
    <div id="modal" class="fixed inset-0 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-w-3xl flex flex-col" hx-target="this" hx-swap="outerHTML">
            <form
                {{if $isEdit}}
                    hx-put="/htmx/alerts/{{.Rule.ID}}"
                {{else}}
                    hx-post="/htmx/alerts/create"
                {{end}}
                hx-swap="innerHTML"
            >
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-bold text-slate-800">{{if $isEdit}}編輯告警規則{{else}}新增告警規則{{end}}</h3>
                    <button type="button" hx-get="/htmx/close" class="text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button>
                </div>

                <div class="p-6 max-h-[75vh] overflow-y-auto" x-data="{ openSection: 'basic' }">
                    <!-- Accordion Item 1: Basic Settings -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden">
                        <div @click="openSection = (openSection === 'basic' ? '' : 'basic')" class="bg-slate-50 hover:bg-slate-100 p-4 flex justify-between items-center cursor-pointer">
                            <h4 class="font-semibold text-slate-800">基本設定</h4>
                            <i data-lucide="chevron-down" class="transition-transform" :class="openSection === 'basic' && 'rotate-180'"></i>
                        </div>
                        <div x-show="openSection === 'basic'" x-transition class="p-4 border-t border-slate-200 space-y-4 text-sm">
                            <!-- Basic settings content -->
                            <div>
                                <label class="font-medium">規則名稱</label>
                                <input type="text" name="name" value="{{if $isEdit}}{{.Rule.Name}}{{end}}" class="mt-1 block w-full rounded-lg border-slate-300">
                            </div>
                             <div>
                                <label class="font-medium">描述</label>
                                <textarea name="description" rows="3" class="mt-1 block w-full rounded-lg border-slate-300">{{if $isEdit}}{{.Rule.Description}}{{end}}</textarea>
                            </div>
                            <div>
                                <label class="font-medium">監控目標 (資源群組)</label>
                                <select name="group_id" class="mt-1 block w-full rounded-lg border-slate-300">
                                    {{range .ResourceGroups}}
                                    <option value="{{.ID}}" {{if and $isEdit (eq .ID (index $.Rule.ResourceFilter.Groups 0))}}selected{{end}}>{{.Name}}</option>
                                    {{end}}
                                </select>
                            </div>
                            <fieldset>
                                <legend class="font-medium mb-2">告警條件</legend>
                                <div class="grid grid-cols-12 gap-2 items-center">
                                    <select name="metric" class="col-span-4 mt-1 block w-full rounded-lg border-slate-300">
                                        <option value="cpu_usage">CPU 使用率</option>
                                        <option value="network_out_bytes">網路輸出流量</option>
                                        <option value="ping_latency_ms">Ping 延遲</option>
                                    </select>
                                    <select name="operator" class="col-span-2 mt-1 block w-full rounded-lg border-slate-300">
                                        <option value="gt">&gt;</option>
                                        <option value="lt">&lt;</option>
                                    </select>
                                    <input type="number" name="threshold" value="{{if $isEdit}}{{.Rule.Condition.Threshold}}{{end}}" placeholder="閾值" class="col-span-3 mt-1 block w-full rounded-lg border-slate-300">
                                    <input type="number" name="duration" value="{{if $isEdit}}{{.Rule.Condition.Duration}}{{end}}" placeholder="持續(秒)" class="col-span-3 mt-1 block w-full rounded-lg border-slate-300">
                                </div>
                            </fieldset>
                        </div>
                    </div>

                    <!-- Accordion Item 2: Automation -->
                    <div class="border border-slate-200 rounded-lg overflow-hidden mt-2">
                        <div @click="openSection = (openSection === 'automation' ? '' : 'automation')" class="bg-slate-50 hover:bg-slate-100 p-4 flex justify-between items-center cursor-pointer">
                            <h4 class="font-semibold text-slate-800">自動化響應 (選填)</h4>
                            <i data-lucide="chevron-down" class="transition-transform" :class="openSection === 'automation' && 'rotate-180'"></i>
                        </div>
                        <div x-show="openSection === 'automation'" x-transition class="p-4 border-t border-slate-200 space-y-4 text-sm">
                            <label class="font-medium">選擇腳本</label>
                            <select name="script_id" class="mt-1 block w-full rounded-lg border-slate-300">
                                <option value="">不使用自動化</option>
                                {{range .Scripts}}
                                <option value="{{.ID}}">{{.Name}}</option>
                                {{end}}
                            </select>
                        </div>
                    </div>

                    <!-- Accordion Item 3: Notification -->
                     <div class="border border-slate-200 rounded-lg overflow-hidden mt-2">
                        <div @click="openSection = (openSection === 'notification' ? '' : 'notification')" class="bg-slate-50 hover:bg-slate-100 p-4 flex justify-between items-center cursor-pointer">
                            <h4 class="font-semibold text-slate-800">通知管道 (選填)</h4>
                            <i data-lucide="chevron-down" class="transition-transform" :class="openSection === 'notification' && 'rotate-180'"></i>
                        </div>
                        <div x-show="openSection === 'notification'" x-transition class="p-4 border-t border-slate-200 space-y-4 text-sm">
                             <label class="font-medium">選擇要通知的管道</label>
                             <select name="notification_channels" multiple class="mt-1 block w-full rounded-lg border-slate-300">
                                {{range .Channels}}
                                <option value="{{.ID}}">{{.Name}}</option>
                                {{end}}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="p-4 border-t bg-slate-50 rounded-b-xl flex justify-end space-x-2">
                    <button type="button" hx-get="/htmx/close" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 font-semibold">取消</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">儲存規則</button>
                </div>
            </form>
        </div>
    </div>
</div>
